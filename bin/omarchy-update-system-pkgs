#!/usr/bin/env bash
# NixOS adaptation: Update system using nixos-rebuild

set -e

echo -e "\e[32m\nUpdate flake inputs\e[0m"
cd /etc/nixos
sudo nix flake update

echo -e "\e[32m\nRebuild system\e[0m"
HOSTNAME=$(hostname)
sudo nixos-rebuild switch --flake /etc/nixos#$HOSTNAME

echo -e "\e[32m\nClean old generations (keep last 5)\e[0m"
sudo nix-env --delete-generations +5 --profile /nix/var/nix/profiles/system
sudo nix-collect-garbage

echo -e "\e[32m\nOptimize nix store\e[0m"
sudo nix-store --optimize

echo
